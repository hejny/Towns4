<?php/* Towns4, www.towns.cz    © Pavel Hejný | 2011-2013   _____________________________   core/login/bot.php   Automatičtí hráči*///==============================//error_reporting(E_ALL ^ E_NOTICE);ini_set("max_execution_time","1000");if($_GET['refresh'])header('refresh:'.($_GET['refresh'])); //e('bot');//==============================/** * Funkce, ktrerá provede automaticky herní kolo pro aktuálně přihlášeného hráče a jeho aktuálně zvolené město * @author PH * @todo: tohle řešení je dobré, ale budoucnost je v tomhle: https://trello.com/b/pM0HJC9e/api-2-boti * * @param float targetx na jaký bod se má bot zaměřit * @param float targety * @param float targetww * */function bot($targetx,$targety,$targetww){	hr();	e(id2name($GLOBALS['ss']['logid']).' ('.$GLOBALS['ss']['logid'].')'.' . ('.$GLOBALS['ss']['useid'].')');	br();		//$buildings=sql_array('SELECT name,COUNT(id) FROM `[mpx]pos_obj` WHERE own='.$GLOBALS['ss']['useid'].' GROUP BY name');	br();        $buildings=sql_array('SELECT name,x,y FROM `[mpx]pos_obj` WHERE own='.$GLOBALS['ss']['useid'].'  AND '.objt().' ORDER BY id DESC');        /*foreach($buildings as $building){            if($name=='{building_main}'){                $targetx=$targetx-$building['x'];                $targety=$targety-$building['y'];                break;            }        }*/        t('bot.php - bot() - buildings');	//br();	//print_r($buildings);                                   //-------------------------- MAIN BUILDING        if($GLOBALS['config']['register_building']){        //if(1){                if($hl=sql_array('SELECT id,ww,x,y FROM `[mpx]pos_obj` WHERE ww='.$GLOBALS['ss']['ww'].' AND own='.$GLOBALS['ss']['useid'].'  AND '.objt().' AND type=\'building\' and TRIM(name)=\''.id2name($GLOBALS['config']['register_building']).'\' LIMIT 1')){                 //print_r($hl);            list($GLOBALS['hl'],$GLOBALS['hl_ww'],$GLOBALS['hl_x'],$GLOBALS['hl_y'])=$hl[0];        }else{//e(1);            $GLOBALS['hl']=0;         }        }else{//e(2);            $GLOBALS['hl']=0;         }        t('bot.php - bot() - main building');        //--------------------------                                        	if(true)	foreach(sql_array("SELECT id,name,func,fp,fs,x,y FROM `[mpx]pos_obj` WHERE own='".$GLOBALS['ss']['useid']."'  AND ".objt()." ORDER BY RAND()",2) as $tmprow){list($id,$name,$func,$fp,$fs,$x,$y)=$tmprow;		e(textbr($name));br();                t('bot.php - bot() - start building');                		//==============================EXT%BOT				if($name=='{building_main}'){		//--------------------------------------------------------------------------------{building_main}*			/*xqr($id.'.xmine attack');			xqr($id.'.xmine attack2');*/			/*for($i=1;$i<20;$i++){				                                $rota=(rand(1,360)/180)*3.1415;				if(count($buildings)>4){					$distance=rand(10,40)/10;				}else{					$distance=rand(10,15)/10;				}				$rotb=rand(1,360);				//$rota=rand(1,10);				//e($id.'.create 1000003,+'.(cos($rota)*$distance).',+'.(sin($rota)*$distance).','.$rotb);				$success=xqr($id.'.create 1000003,+'.(cos($rota)*$distance).',+'.(sin($rota)*$distance).','.$rotb);				if($success){success('POSTAVENO');break;}			}*/                        for($i=5;$i>0;$i--){                                $pathx=(-$targetx+$GLOBALS['hl_x'])*($i/10)+(rand(-600,600)/100);                                $pathy=(-$targety+$GLOBALS['hl_y'])*($i/10)+(rand(-600,600)/100);                                                                $rotb=rand(1,360);                                                                $success=xqr($id.'.create 1000003,+'.($pathx).',+'.($pathy).','.$rotb);				if($success){success('STAVITEL POSTAVENO');break;}			}                                                                        if(!$success){error('NEPOSTAVENO');}		//-----------------------------------------------------------------------------------------------		}elseif($name=='{building_master_wall}' or $name=='{building_master_terrain}'){		//-------------------------------------------------------------------------{building_master_wall}			//create			/*Palisáda(1000006)			Malá kamenná hradba(1000007)			Velká kamenná hradba(1000008)			Temná hradba(1000009)*/			if($name=='{building_master_wall}'){				$walls=array(array(1000006,'building_palisade',2,5),array(1000007,'building_small_wall',8,10)/*,array(1000008,'building_big_wall',11,15),array(1000009,'building_dark_wall',15,20)*/);			}else{				$walls=array(array(1000111,'building_terrainx_t11',10,14)/*,array(1000008,'building_big_wall',11,15),array(1000009,'building_dark_wall',15,20)*/);			}			foreach($walls as $row){				//print_r($row);				list($wallid,$wallname,$min,$max)=$row;				//echo("$wallid,$wallname,$min,$max");				$distance=0;				foreach($buildings as $building){					list($name,$tmpx,$tmpy)=$building;					if($name==$wallname){						$x=$tmpx;$y=$tmpy;						$distance=sqrt($x*$x+$y*$y);						$rot=acos($x/$distance);						if($y<0)$rot=(2*3.1415)-$rot;												//break;					}				}				if(!$distance){					echo("$wallid,$wallname,$min,$max");					e("[$min,$max]");					$distance=rand($min,$max);					$rot=(rand(1,360)/180)*3.1415;					//$x=round(cos($rot)*$distance);					//$y=round(sin($rot)*$distance);				}								//e("[$x,$y]($rot,$distance)");							$q=true;$i=rand(1,19);				while(/*$q and */$i){$i--;					$x=round(cos($rot)*$distance);					$y=round(sin($rot)*$distance);										//e("[$x,$y]($rot,$distance)");					$q=xqr($id.'.create '.$wallid.',+'.$x.',+'.$y);												$rot+=deg2rad(10);					$distance+=(rand(0,10)-5)/10;					/*if(rand(1,2)==1){						if($x>0){							$x--;						}else{							$x++;						}					}else{						if($y>0){							$y--;						}else{							$y++;						}					}*/				}			}		//-----------------------------------------------------------------------------------------------		}elseif($name=='{building_master}'){		//------------------------------------------------------------------------------{building_master}			//create			/*Stavitel(1000003)*			Ambasáda(1000005)*			Těžba dřeva(1000014)*			Těžba kamene(1000015)*			Velká těžba dřeva(1000017)*			Velká těžba kamene(1000018)*			Rozhledna(1000020)*			Expanzní věž(1000021)*			Obranná věž(1000023)*			Malý chrám(1000024)*			Velký chrám(1000025)*			Stavitel hradeb(1000026)*			Stavitel mostů(1000027)*			Stavitel mapy(1000029)**/			if(!$bps or $bpi>=count($bps)){				$bpi=0;				/*$bpsx=sql_array('SELECT id FROM `[mpx]pos_obj` WHERE ww=0 AND func LIKE \'%group=class[5]group[3]1[5]profile[3]profile[5]group[7]5[10]main%\' ORDER by fs');				//print_r($bpsx);				$bps=array();				foreach($bpsx as $tmp){$tmp=$tmp[0];if($tmp!=1000002){$bps[]=$tmp;}}				$bps[]=1000002;*//*array(1000015,1000014,1000026,1000027,1000029,1000017,1000018,1000005,1000020,1000021,1000023,1000024,1000025/*,1000003);*/$bps=array(1000014,1000015,//1000032,//sklad//1000034,//sklad//1000035,//sklad//1000033,//sklad1000037,1000031,1000020,1000004,1000029,1000026,1000027,1000036,1000002/*vlajka*/);if(rand(1,10)>7)shuffle($bps);			}			for($i=5;$i>0;$i--){				//$rota=(rand(1,360)/180)*3.1415;				//$distance=rand(10,   10*(0+pow(count($buildings),gr-1))  )/10;                                                                    //e($targetx.','.$GLOBALS['hl_x']);                                $pathx=($targetx-$GLOBALS['hl_x'])*($i/10)+(rand(-400,400)/100);                                $pathy=($targety-$GLOBALS['hl_y'])*($i/10)+(rand(-400,400)/100);                                				//e(id2name($bps[$bpi]).'pathx='.$pathx.' buildings='.count($buildings));				$rotb=rand(1,360);                                                                blue($id.'.create '.($bps[$bpi]).',+'.($pathx).',+'.($pathy).','.$rotb);				$success=xqr($id.'.create '.($bps[$bpi]).',+'.($pathx).',+'.($pathy).','.$rotb);			if($success){if(defined('join_id')){success('PŘISTAVENO K '.join_id);}else{success('POSTAVENO');}break;}			}			//e($id.'.create '.($bps[$bpi]).',+'.(cos($rota)*$distance).',+'.(sin($rota)*$distance).','.$rotb);			$bpi++;			//-----------------------------------------------------------------------------------------------		}elseif($name=='{building_master_bridge}'){		//-----------------------------------------------------------------------{building_master_bridge}			//create				//-----------------------------------------------------------------------------------------------		//}elseif($name=='{building_master_terrain}'){		//----------------------------------------------------------------------{building_master_terrain}			//create				//-----------------------------------------------------------------------------------------------		}elseif($name=='{building_embassy}'){		//-----------------------------------------------------------------------------{building_embassy}			//change				//-----------------------------------------------------------------------------------------------		}elseif($name=='{building_lumberjack}'){		//--------------------------------------------------------------------------{building_lumberjack}*			//attack			//xqr($id.'.xmine attack');		//-----------------------------------------------------------------------------------------------		}elseif($name=='{building_mine}'){		//--------------------------------------------------------------------------------{building_mine}*			//attack			//xqr($id.'.xmine attack');		//-----------------------------------------------------------------------------------------------		}elseif($name=='{building_big_lumberjack}'){		//----------------------------------------------------------------------{building_big_lumberjack}*			//attack,attack2			//xqr($id.'.xmine attack');			//xqr($id.'.xmine attack2');		//-----------------------------------------------------------------------------------------------		}elseif($name=='{building_big_mine}'){		//----------------------------------------------------------------------------{building_big_mine}*			//attack,attack2			xqr($id.'.xmine attack');			xqr($id.'.xmine attack2');		//-----------------------------------------------------------------------------------------------		}elseif($name=='{building_tower}'){		//-------------------------------------------------------------------------------{building_tower}			//attack				//-----------------------------------------------------------------------------------------------		}elseif($name=='{building_expand_tower}'){		//------------------------------------------------------------------------{building_expand_tower}			//attack				//-----------------------------------------------------------------------------------------------		}elseif($name=='{building_defence_tower}'){		//-----------------------------------------------------------------------{building_defence_tower}			//attack				//-----------------------------------------------------------------------------------------------		}elseif($name=='{building_small_temple}'){		//------------------------------------------------------------------------{building_small_temple}			//attack				//-----------------------------------------------------------------------------------------------		}elseif($name=='{building_big_temple}'){		//--------------------------------------------------------------------------{building_big_temple}			//attack,attack2				//----------------------------------------------------------------------------------------------- 		}		//----------------------------------------------------------------------------------------------- 		if($fp!=$fs){			xqr($id.'.repair');		}                                t('bot.php - bot() - end building');	}/**/		//die();		//--------------------------------------------------------------------------ATTACK				success('ATTACKING');		$attack_buildings=sql_array('SELECT id,name,x,y,ww FROM `[mpx]pos_obj` WHERE own=\''.$GLOBALS['ss']['useid'].'\'  AND '.objt().' AND func LIKE \'%attack%\' AND func NOT LIKE \'%tree%\' AND func NOT LIKE \'%rock%\' ',2);br();		foreach($attack_buildings as $row){			list($id,$name,$x,$y,$ww)=$row;			$aid=sql_1data('SELECT id FROM `[mpx]pos_obj` WHERE ww='.$ww.' AND own!=\''.$GLOBALS['ss']['useid'].'\'  AND '.objt().' AND type=\'building\' ORDER BY POW(x-'.$x.',2)+POW(y-'.$y.',2) ',2);br();			e(textbr($name)."($id)[$x,$y] to $aid(".id2name($aid).')');br();						xqr($id.'.attack,'.$aid);		}                t('bot.php - bot() - attacking');		//--------------------------------------------------------------------------DISMANTLE				success('DISMANTLE');		//SQL dotaz pro vybrání všech budov		$sql='SELECT id,x,y,name,origin FROM `[mpx]pos_obj` WHERE own='.$GLOBALS['ss']['useid'].' AND `name`!=\''.mainname().'\' AND '.objt().' ORDER BY RAND()';		//--------------------------------------------Rozebrání všech budov nad lvl 80		$dismantle_buildings=sql_array($sql,2);		foreach($dismantle_buildings as $building) {			$lvl = count(explode(',',$building['origin']));			e($building['name']." ($lvl)");			if ($lvl >= 80) {				textb(" dismantled");				xqr('dismantle ' . $building['id']);			}			br();		}		//--------------------------------------------Rezebrání všech budov blízko u sebe		/*$dismantle_buildings=sql_array($sql,2);		$limit=20;		foreach($dismantle_buildings as $buildingA){			textb($buildingA['name']);br();			foreach($dismantle_buildings as $buildingB){				//e('<td>');				if($buildingA['id']!=$buildingB['id']){					$distance=sqrt(pow($buildingA['x']-$buildingB['x'],2)+pow($buildingA['y']-$buildingB['y'],2));					echo($buildingA['name'].' -('.$distance.')- '.$buildingB['name']);br();					if($distance<1 and $distance!=0){						$efA=substr_count('{and}',$buildingA['name']);						$efB=substr_count('{and}',$buildingB['name']);						if($efA>$efb){							$query=('dismantle '.$buildingA['id']);						}else{							$query=('dismantle '.$buildingB['id']);						}						blue($query);						xqr($query);						$limit--;						if($limit<=0){							break(2);						}					}				}				//e('</td>');			}			//e('</tr>');		}*/		//--------------------------------------------------------------------------		success('END');}//=====================================================================================================================================Výběr, který bot bude spuštěnsuccess('BOTS');if($_GET['username']){//-------------------------------------------------------------------------------------------------------KONKRETNI UZIVATEL	xqr('login '.$_GET['username'].' towns '.$_GET['password']);	if(logged()){		bot();	}}else{//-------------------------------------------------------------------------------------------------------TARGET	//--------------------------------------------------Výroba podmínky pro výběr všech botů	t('bot.php - start');	$bots=array();	foreach(sql_array("SELECT (SELECT (SELECT x.id FROM `[mpx]pos_obj` as x WHERE x.own=`[mpx]pos_obj`.id AND ".objt()." AND type='town2' LIMIT 1 ) FROM `[mpx]pos_obj` WHERE `[mpx]pos_obj`.userid=[mpx]users.id AND ".objt()." AND type='user' LIMIT 1) FROM [mpx]users WHERE `password`='".md5($GLOBALS['inc']['bot_password'])."' and aac=1 ") as $row){	$bots[]=$row[0];	}	$botsw=implode("' OR own='",$bots);	$botsw="(own='$botsw')";	t('bot.php - select bots');	//--------------------------------------------------Výběr poslední postavené nebo přistavené budovy	foreach(sql_array('SELECT id,name,own,x,y,ww FROM `[mpx]pos_obj` WHERE `own`!=0 AND `ww`>0 AND `name`!=\''.mainname().'\' AND !'.$botsw.' AND `type`=\'building\' AND starttime>'.(time()-(3600*24*2)).' ORDER BY RAND() LIMIT 2') as $row){		$targetx=$row['x'];		$targety=$row['y'];		$targetww=$row['ww'];	}	t('bot.php - select near');	//--------------------------------------------------Výběr own nejbližší botské budovy	$botids=array();	foreach(sql_array('SELECT DISTINCT(SELECT x.own FROM `[mpx]pos_obj` as x WHERE `[mpx]pos_obj`.own=x.id AND '.objt().' AND type=\'town2\' LIMIT 1 ) FROM `[mpx]pos_obj` WHERE `own`!=0 AND `ww`='.$targetww.' AND '.$botsw.' AND `type`=\'building\' AND '.objt().' ORDER BY POW(`x`-'.$targetx.',2)+POW(`y`-'.$targety.',2) LIMIT 2',3) as $row){		$botids[]=$row[0];	}	//--------------------------------------------------Provádění vybraných robotů	//Všichni roboti//foreach(sql_array('SELECT id FROM [mpx]login WHERE `method`=\'bot\' ORDER BY time_use LIMIT 1') as $id){list($id)=$id;//LIMIT 1=sracka	foreach($botids as $id){		//sql_query('UPDATE [mpx]login SET `time_use`='.time().' WHERE `method`=\'bot\' AND `id`='.$id);		//if($reporting){success('ID'.$id."(".id2name($id)."):");br();}		force_login($id);		blue("force_login($id);");                t('bot.php - force login');        		if($_GET['uc']){			success('Unlimited Cooldown');			sql_query("UPDATE `[mpx]pos_obj` SET `set`='' WHERE type='building' AND own=".$GLOBALS['ss']['use_object']->id,2);br();		}		if($_GET['ul']){			success('Unlimited Resource');			//sql_query("UPDATE `[mpx]pos_obj` SET `set`='' WHERE type='building' AND own=".$GLOBALS['ss']['use_object']->id,2);br();			//$newhold=new hold('wood=10000;stone=10000;iron=10000;fuel=10000');			$GLOBALS['ss']['use_object']->hold->val('wood',10000);			$GLOBALS['ss']['use_object']->hold->val('stone',10000);			$GLOBALS['ss']['use_object']->hold->val('iron',10000);			$GLOBALS['ss']['use_object']->hold->val('fuel',10000);						//print_r($GLOBALS['ss']['use_object']->hold->vals2list());			//$GLOBALS['ss']['use_object']->hold=$newhold;		}                t('bot.php - ul/uc');                t('bot.php - before bot()');		bot($targetx,$targety,$targetww);                t('bot.php - after bot');		$GLOBALS['ss']["log_object"]->update();		$GLOBALS['ss']["use_object"]->update();		unset($GLOBALS['ss']["log_object"]);		unset($GLOBALS['ss']["use_object"]);                                t('bot.php - logout');			}}//-------------------------------------------------Vlastní statistikaqlog('bot');//-------------------------------?>